# Artifactory Resource
The Artifactory resource lets you integrate your pipeline jobs with maven repositories in Artifactory.

This integration allows:

- To deploy artifacts and poms generated by your build
- To retreive artifacts in a repository
- To trigger jobs when a new version of an artifact is available
## Source Configuration
* `host`: *Required.* The fully qualified domain name including the context root.
* `api_key`: *Required.* The API key of a user with sufficient read and write privileges on the repositories you wish to use
* `repository_id`: *Required.* The repository 
* `group_id`: *Required.* The maven groupId of your artifact
* `artifact_id`: *Required.* The maven artifactId of your artifact
* `version`: *Optional.* Information about the version to deploy. This overrides the default behavior of retrieving the lastest version of an artefact. The resource fetches the version from a JSON file in a git repository.
    * `uri`: *Required.* The location of the repository.
    * `file`: *Optional.* The name of the JSON file. Default name is `artifact.json`. See the [example](#version-file) below.
    * `branch`: *Optional.* The branch to track. If unset, the `master` branch is used.
    * `key`: *Optional.* The key of the JSON entry for the version in the file. Default key is `version`. See the [example](#version-file) below.
    * `username`: *Optional.* Username for HTTP(S) auth when fetching. This is needed when only HTTP/HTTPS protocol for git is available (which does not support private key auth) and auth is required.
    * `password`: *Optional.* Password for HTTP(S) auth when fetching.
    * `private_key`: *Optional.* Private key to use when fetching.
### Example
Resource Type Configuration:
``` yaml
resource_types: 
  - 
    name: artifactory
    source: 
      repository: emeraldsquad/artifactory-resource
      type: docker-image
```
Resource configuration for an artifact:
``` yaml
resources: 
  - 
    name: my-artifact
    type: artifactory
    source: 
      api_key: <API KEY>
      artifact_id: wonderful-artifact
      group_id: emerald.squad
      host: "https://emerald.squad.com/artifactory"
      repository_id: repo-local
```
<a name="version-file"></a>Get a specific version using a JSON version file:
``` yaml
resources:
  - name: artifact
    type: artifactory
    source:
      host: "https://emerald.squad.com/artifactory"
      api_key: <API KEY>
      repository_id: repo-local
      group_id: emerald.squad
      artifact_id: wonderful-artifact
      version:
        uri: ssh://git@git.emerald.squad.com/wonderful-artifact.git
        file: artifact-versions.json
        key: wonderful-artifact
        private_key: |
          -----BEGIN RSA PRIVATE KEY-----
          ...
          -----END RSA PRIVATE KEY-----
```
The JSON file in the git repo would look like this:
``` json
{
  "wonderful-artifact": "1.0.0"
}
```

*Note:* Artifactory resource is using Artifactory Query Language (AQL) to extract metadata from the repositories. Currently, AQL can only extract data that resides in your instance of Artifactory, so it runs on local repositories, remote repository caches and virtual repositories. So, if your artifact is stored on a remote repository, you must specify the cache repository instead.

Retreiving artifacts:

``` yaml
- get: my-artifact
```

``` yaml
- get: my-artifact
  params: 
    qualifiers: [sources,javadoc]
```
Pushing local commits to the repo:
``` yaml
- put: my-artifact
  params:
    path: artifacts
```
## Behavior
### `check`: Check for new artifacts.
The resource searches for folders under `http(s)://<host>/<repository_id>/<group_id>/<artifact_id>`. It expects to get a list of valid maven versions (See https://cwiki.apache.org/confluence/display/MAVENOLD/Versioning for details). All subsequent versions of the given ref are returned. If no version is provided, the resource returns only the latest.
### `in`: Download the artifacts at the given ref.
Download the artifacts of the given ref to the destination. It will return the same given ref as version.
#### Parameters
* `qualifiers`: *Optional.* The artifacts qualifiers ex: [source,javadoc]. If specified, the resource will only retreive the qualified artifacts.
### `out`: Push the artifacts to the repository.
Push the artifacts from the given path to the Artifactory maven repository. The resource will push every files presents in the folder specified in the **path** parameter. The version parameter is optionnal but the resource expect at least a version file containing a version in the format `<timestamp>-<git hash>`. You can easily generate a version of this format from your pipeline using the shell `echo "$(date +'%s')-$(git rev-parse --short HEAD)" > version`.
#### Parameters
* `path`: *Required.* The path of the files to push to the repository.
* `version`: *Optional.* The path to a version file. Defaults to `<path parameter>/version`.